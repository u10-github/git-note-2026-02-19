要求仕様：タイムマシン日記・メモ（GitHub連携PWA）
1. 目的・思想
1.1 目的

思いついたらすぐ書けて、すぐ修正できる。

**変更履歴（差分）を確認でき、いつでも過去に戻れる（復元できる）**ことにより、安心して書き続けられる。

1.2 思想（ユーザー体験の原則）

ユーザーに Git の知識（push/pull/merge/ブランチ等）を要求しない。

データは プレーンテキスト資産（.md） として GitHub リポジトリに残る。

失敗や競合が起きても ユーザーの文章を失わない（安全側）。

2. 対象環境・前提
2.1 クライアント

PWA（ブラウザベース）。スマホ利用を主ターゲット。

起動・バックグラウンド遷移・通信断が起きうる前提で設計する。

2.2 バックエンド・連携先

GitHub と連携する。

将来の配布/公開を視野に、認証・権限制御は GitHub App を前提とする。

サーバー側（Cloudflare Workers 等）を介して GitHub と通信する（PWAが直接秘密情報を保持しない）。

3. データ要件
3.1 ノート形式

対象ファイル拡張子：.md（日記は必ず .md）

文字コード：UTF-8

3.2 設定ファイル（リポジトリ内）

設定はリポジトリ内に保存し、端末変更でも引き継げること。

保存先：.app/config.json（固定）

設定はテキスト資産として扱い、ユーザーが編集可能であること。

4. 起動時の動作（Start View）
4.1 起動動作の選択肢

起動時の表示は選べる設計を想定し、少なくとも以下を提供する（将来拡張含む）：

今日のページを開く（Journal Today）

メモ一覧を開く（Recent Notes）

フォルダ一覧を開く（Folder Browser）

（追加候補として検討）クイック入力／前回開いたノート

4.2 デフォルト

ユーザー（開発者自身）のデフォルトは 「今日のページを開く」。

5. 日記モード（Journal Today）
5.1 保存先フォルダ

日記は、あらかじめ指定したフォルダに 自動で書き溜める。

例：01_diary/（ユーザー指定可能）

5.2 ファイル命名規則（Asia/Tokyo）

1日1ファイルで作成する。

デフォルトのパターン（例）：

01_diary/YYYY/MM/YYYY-MM-DD.md

日付の基準タイムゾーン：Asia/Tokyo

5.3 起動時生成ロジック

今日のファイルが存在する場合：そのファイルを開く。

存在しない場合：テンプレートで新規作成して開く。

既存ファイルを上書きしてはならない（存在チェック必須）。

5.4 テンプレート

ユーザーが自由記述でテンプレートを設定できる。

日記ファイル先頭には必ずタイトル行を入れる：

# YYYY-MM-DD

テンプレ内で最低限 {{date}} を展開できること。

6. 編集・保存
6.1 編集

Markdown編集ができること。

（将来）プレビューは任意だが、MVPでは編集中心でよい。

6.2 保存方式（確定）

手動保存：ユーザー操作（保存ボタン）で保存ポイントを作成する。

離脱時保存：編集画面から離れる際に保存を試みる。

バックグラウンド時保存：アプリがバックグラウンドへ遷移する際に保存を試みる（スマホ前提）。

6.3 自動保存の歯止め（確定：C）

離脱時/バックグラウンド時の保存はコミット乱発を防ぐため、以下を満たす場合のみ GitHub 側へ保存（コミット）を試行する：

時間条件：最後の保存から一定秒以上経過（例：30秒）
または

変更量条件：一定文字数以上の変更（例：20文字）

満たさない場合：

ローカル下書きのみ更新し、GitHubへは保存しない。

7. ローカル下書き（オフライン/失敗耐性）
7.1 下書き保存（必須）

編集内容は端末ローカルに下書きとして保持できること（IndexedDB 等）。

GitHubへの保存に失敗しても、下書きは必ず残ること。

7.2 起動時の優先順位（確定：A）

起動時、対象ノートにローカル下書きが存在する場合：

ローカル下書きを優先して開く

状態として「未同期」を明示する

7.3 未同期UI

「未同期（下書きは端末に保存済み）」を明示し、

「同期する（=手動保存）」導線を提供する。

8. 競合（他端末更新）時の扱い
8.1 競合検知

GitHub側の最新版と、下書きの基準（base）を比較し、差異があれば競合と判断する。

8.2 競合時のデフォルト（確定：A）

競合時は自動マージしない。

デフォルトの解決策は 「別名で保存」（ユーザーの文章を失わない）。

別名保存の命名規則（例）：

YYYY-MM-DD_conflict_YYYYMMDD-HHMMSS.md（Asia/Tokyo）

9. 履歴・差分・復元（タイムマシン機能）
9.1 履歴

ファイル単位で保存ポイント（コミット）一覧を表示できること。

9.2 差分

保存ポイント間の変更点（diff）を閲覧できること。

9.3 復元（確定：A）

復元は ファイル単位で行う。

指定した保存ポイント時点の内容を、現在版として上書き保存（新しい保存ポイントを作る）する。

復元操作自体も履歴に残ること。

10. 設定要件（最低限）

.app/config.json に最低限含めるべき項目（例）：

startView

homeFolder

journal.folder

journal.pattern

journal.timezone（Asia/Tokyo）

journal.template

save.manual

save.onLeave

save.onBackground

save.autosaveThrottleSeconds

save.autosaveMinChars

11. 非目標（明示）

ローカル Git リポジトリを端末に保持しない。

Gitの高度機能（ブランチ/merge/pull/push等）をUIに露出しない。

自動マージは行わない。

GitHub以外のホスティング対応は当面対象外。
